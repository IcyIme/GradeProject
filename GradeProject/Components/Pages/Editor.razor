@page "/repl/playground/0a1"
@using GradeProject.Services
@using Radzen
@attribute [Authorize]
@inject IJSRuntime JSRuntime
@inject DialogService DialogService

<style>
    #myEditor {
        height: 50vh; /* Set the height to 50% of the viewport height */
        width: 100%; /* Set the width to 100% */
    }
</style>

<div class="h-100 w-100">
    <StandaloneCodeEditor @ref="myEditor" Id="myEditor" ConstructionOptions="EditorConstructionOptions" OnDidChangeModelContent="HandleContentChange" />
</div>

<button @onclick="ExecuteCode">Execute Code</button>

@if (!string.IsNullOrEmpty(output))
{
    <pre>@output</pre>
    <p>@evaluationResult</p>
}

<RadzenDialog />

@code {
    private StandaloneCodeEditor myEditor;
    private async Task HandleContentChange()
    {
        code = await myEditor.GetValue();
    }

    private string code = "using System;\n\npublic class Program\n{\n    public static void Main()\n    {\n        Console.WriteLine(\"Hello, world!\");\n    }\n}";
    private List<string> userInputs = new List<string>();
    private string output = "";
    private string evaluationResult = "";

    [Inject]
    private ICSharpExecutorService ExecutorService { get; set; }

    private StandaloneEditorConstructionOptions EditorConstructionOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
            {
                AutomaticLayout = true,
                Language = "csharp",
                Theme = "vs-dark",
                Value = code,
            };
    }

    private async Task ExecuteCode()
    {
        userInputs.Clear();

        // Find the number of Console.ReadLine() occurrences
        int readLineCount = code.Split(new[] { "Console.ReadLine()" }, StringSplitOptions.None).Length - 1;

        // Prompt for inputs sequentially
        for (int i = 0; i < readLineCount; i++)
        {
            var result = await DialogService.OpenAsync<InputDialog>($"Enter input for Console.ReadLine() #{i + 1}",
                new Dictionary<string, object> { { "Prompt", $"Enter input for Console.ReadLine() #{i + 1}:" } });
            userInputs.Add(result as string);
        }

        string expectedOutput = "Hello, world!";
        output = ExecutorService.ExecuteCSharpCode(code, userInputs);

        if (output.Trim() == expectedOutput)
        {
            evaluationResult = "Code execution successful!";
        }
        else
        {
            evaluationResult = "Code execution failed. Expected output: " + expectedOutput;
        }
    }
}
